stages:
  - build
  - test
  - code-analysis
  - security-analysis
  - package
  - deploy-staging
  - deploy-production

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/
    - target/

# Build Stage
build:
  stage: build
  image: maven:3.8.4-openjdk-8
  script:
    - mvn $MAVEN_CLI_OPTS clean compile
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

# Test Stage
test:
  stage: test
  image: maven:3.8.4-openjdk-8
  script:
    - mvn $MAVEN_CLI_OPTS test
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 hour
  coverage: '/Total.*?([0-9]{1,3})%/'

# Code Analysis with SonarQube
code-analysis:
  stage: code-analysis
  image: maven:3.8.4-openjdk-8
  script:
    - mvn $MAVEN_CLI_OPTS sonar:sonar
      -Dsonar.projectKey=$CI_PROJECT_NAME
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_TOKEN
  only:
    - main
    - develop
  allow_failure: true

# Security Analysis - OWASP Dependency Check
security-owasp:
  stage: security-analysis
  image: maven:3.8.4-openjdk-8
  script:
    - mvn $MAVEN_CLI_OPTS org.owasp:dependency-check-maven:check
  artifacts:
    reports:
      dependency_scanning: target/dependency-check-report.json
    paths:
      - target/dependency-check-report.html
    expire_in: 1 week
  allow_failure: true

# Security Analysis - Snyk
security-snyk:
  stage: security-analysis
  image: node:16-alpine
  before_script:
    - npm install -g snyk
    - snyk auth $SNYK_TOKEN
  script:
    - snyk test --severity-threshold=high
    - snyk monitor
  allow_failure: true
  only:
    - main
    - develop

# Package Stage
package:
  stage: package
  image: maven:3.8.4-openjdk-8
  script:
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

# Docker Build
docker-build:
  stage: package
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  dependencies:
    - package

# Deploy to Staging
deploy-staging:
  stage: deploy-staging
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker stop staging-app || true
    - docker rm staging-app || true
    - docker run -d --name staging-app -p 8080:8080 $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - sleep 30
    - curl -f http://localhost:8080/health || exit 1
  environment:
    name: staging
    url: http://staging.example.com
  only:
    - main
    - develop

# Deploy to Production (Manual)
deploy-production:
  stage: deploy-production
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    # Blue-Green Deployment Strategy
    - |
      if docker ps | grep -q "production-app-blue"; then
        NEW_COLOR="green"
        OLD_COLOR="blue"
      else
        NEW_COLOR="blue"
        OLD_COLOR="green"
      fi
    - docker run -d --name production-app-$NEW_COLOR -p 8081:8080 $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - sleep 30
    - curl -f http://localhost:8081/health || exit 1
    # Switch traffic
    - docker stop production-app-$OLD_COLOR || true
    - docker rm production-app-$OLD_COLOR || true
    - docker stop production-app-$NEW_COLOR
    - docker run -d --name production-app-$NEW_COLOR -p 8080:8080 $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  environment:
    name: production
    url: http://production.example.com
  when: manual
  only:
    - main

# Notification Job
notify-success:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data '{"text":"✅ Pipeline succeeded for '"$CI_PROJECT_NAME"' - '"$CI_COMMIT_REF_NAME"'"}' \
      $SLACK_WEBHOOK_URL
  when: on_success
  only:
    - main
    - develop

notify-failure:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data '{"text":"❌ Pipeline failed for '"$CI_PROJECT_NAME"' - '"$CI_COMMIT_REF_NAME"'"}' \
      $SLACK_WEBHOOK_URL
  when: on_failure
  only:
    - main
    - develop